<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Goolge Image Search By Drawing</title>
		<script src="canvasdrawing_for_searchbydrawing.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Cedarville+Cursive' rel='stylesheet' type='text/css'>
		<style>
			canvas {
				border: solid 1px #ccc;
				#cursor: crosshair;
				cursor:crosshair;
			  margin:0 0 0 0;
        padding:0 0 0 0;
			}
			canvas:hover
			{
			  cursor:crosshair;
			}
			canvas:active
			{
			  cursor:crosshair;
			}
			#wrapper {
				width: 720px;
				margin: 0 auto;
				border: 0px solid green;
			}
			.buttonblock {
display: block;
border: 1px solid #999;
height: 30px;
border-color: #ccc #999 #999 #ccc;
}
.button {
 background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(rgb(255, 255, 255)), to(rgb(221, 221, 221)));
 background: -moz-linear-gradient(-90deg,#FFF,#DDD);
width: 478px;
font: 15px arial,sans-serif;
color: #000;
cursor: pointer;
height: 30px;
margin: 0;
outline: 0;
border: 0;
}
.button:active {
background: #ccc;
}
.inline{
width: 480px;
display: inline-block; 
}

#totally
{
  font-family:  monospace; font-weight: 100; font-size:1em; color:gray;
}

#colors
{
  /*margin:2px 2px 7px 2px;*/
  padding:0 0 0 0;
  margin:0 0 0 0;
  list-style-type: none;
  /*display:block;*/
  display:inline;
}

.color
{
	padding:0px 0px 0px 0px;
	margin:0px 0px 0px 0px;
	border: 1px solid #000;
	list-style: none;
	display: inline-block;
	width:15px;
	height:15px;
  
  
}

#range {
  
   width: 480px;
}

#logo
{
  padding:0px 0px 0px 0px;
	margin:0px 0px 0px 0px;
}

.hover
{
  border: 5px solid green;
}

#text
{
  text-align:left;
}

#capture
{
 
}

#phototrigger
{
 font-family:  monospace; font-weight: 100; font-size:1em; color:gray;
 position:relative;
 bottom:5px;
}

		</style>
	</head>
<body>

	<center id="wrapper">
	  <div><div id="totally">totally unoffical</div>
	  <img src="http://www.google.com/logos/van_gogh.gif" id="logo">
	  </div>
		<div><canvas id="canvas" width="480" height="360">
			<p>Your browser doesn't support canvas!</p>
		</canvas></div>
		
	  <input type="range" id="range" min="1" max="200" step="1" value="50" /><br>
    <ul id="colors"></ul>
    <span class="withflash" id="phototrigger" ><a href="javascript://" id="capture">Photo</a></span>
		<div><span class="inline"><span class="buttonblock"><input name="second" type="submit" value="Search by Drawing" class="button" id='search'></span></span></div>
		<!-- picture --->
		<div class="container" class="withflash">
    <object  class="withflash" id="iembedflash" classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,0,0" width="320" height="240">
  		<param name="movie" value="camcanvas.swf" />
  		<param name="quality" value="high" />
		<param name="allowScriptAccess" value="always" />
  		<embed  class="withflash" allowScriptAccess="always"  id="embedflash" src="camcanvas.swf" quality="high" width="320" height="240" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" mayscript="true"  />
    </object>
    </div>
    <!--picture end--->
	<div id='text'>
	<h2>To-Do</h2>
	<ul>
	  <li>List of all 'non drag n drop' images.</li>
	  <li>search bar with better url for cooler sharing</li>
	  <li>deploy and launch for jsconfeu</li>
	</ul>
	<h2>How-To</h2>
	<h3>Draw and Search</h3>
	<ul>
	  <li>Choose a color.</li>
	  <li>Draw something.</li>
	  <li>Adjust pencil size with the range slider.</li>
	  <li>Choose another color.</li>
	  <li>Draw some more.</li>
	  <li>Click on the "Search by Drawing" button.</li>
	</ul>
	<h3>Drag'n Drop, Draw and Search</h3>
	<ul>
	  <li>Drag and drop an image from your computer into the drawing area.</li>
	  <li>Wait a second.</li>
	  <li>Draw something on the picture.</li>
	  <li>Click on the "Search by Drawing" button.</li>
	</ul>
	<h2>FAQ</h2>
	<ul>
	  <li>
	    <ul>
	      <li>Is this an offical Google product?</li>
	      <li>No, this is totally unoffical.</li>
	    </ul>
	  </li>
	  <li>
	    <ul>
	      <li>Is this sitea affilaited with Google?</li>
	      <li>No.</li>
	    </ul>
	  </li>
	  <li>
	    <ul>
	      <li>Are you a Googler?</li>
	      <li>No.</li>
	    </ul>
	  </li>
	  <li>
	    <ul>
	      <li>Then why is the Google doodle on top of the page?</li>
	      <li>It's a <b><a href="http://en.wikipedia.org/wiki/Homage">homage</a></b> and the main image search action happens on via <a href="http://www.google.com/insidesearch/searchbyimage.html">Google Search by Image</a>.</li>
	    </ul>
	  </li>
	  <li>
	    <ul>
	      <li>Who created this?</li>
	      <li>I did. Well kinda. The "<a href="http://www.google.com/insidesearch/searchbyimage.html">Search by Image</a>" functionality is provided by Google. Accessable via a simple URL. The canvas drawing thingie is a fork of <a href="https://github.com/godrin/drawingCanvas">drawingCanvas</a> by a guy called <a href="https://github.com/godrin">godrin</a>. I glued it together.</li>
	    </ul>
	  </li>
	   <ul>
	      <li>How does this work?</li>
	      <li>You mean technically? Quite simple actually.
	        <ul>
	          <li>You draw something on an HTML5 canvas.</li>
	          <li>Click on Search</li>
	          <li>Image gets converted into a base64 encoded data uri</li>
	          <li>Image data gets send to server (powered by Heroku)</li>
	          <li>Image gets uploaded to Amazon S3</li>
	          <li>The Amazon S3 Image URL gets communicated back to your browser.</li> 
	         <li>Browser gets redirected to Google Search by Image.</li>
	        </ul>
	      <li>
	    </ul>
	  </li>
	  <li>
	    <ul>
	      <li>Who are you?</li>
	      <li>Franz Enzenhofer - Github, Twitter, G+ and i even have a Fan-Page on Fb.</li>
	    </ul>
	  </li>
	  <li>
	    <ul>
	      <li>What technology did you use?</li>
	      <li>
	        <ul>
	          <li>emacs</li>
	          <li>HTML5 canvas</li>
	          <li>HTML5 drag/drop API</li>
	          <li>CoffeeScript</li>
	          <li>jQuery</li>
	          <li>socket.io</li>
	          <li>node.js</li>
	          <li>Heroku Cedar Stack</li>
	          <li>Amazon S3</li>
	        </ul>
	      </li>
	    </ul>
	  </li>
	  <li>
	    <ul>
	      <li>Does this work over all browsers?</li>
	      <li>No, i tested it on Chrome, Safari on Mac.</li>
	    </ul>
	  </li>
	  <li>
	    <ul>
	      <li>Can i fork it?</li>
	      <li>Sure.</li>
	    </ul>
	  </li>
	  <li>
	    <ul>
	      <li>Thx</li>
	      <li>You are welcome.</li>
	    </ul>
	  </li>	
	</ul>
	</div>
	</center>
<div>
		<script src="http://jashkenas.github.com/coffee-script/extras/coffee-script.js"></script>
		<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js'></script>
		<script src="/socket.io/socket.io.js"></script>
		<script type="text/coffeescript">
cd = new CanvasDrawing "canvas"

default_width = cd.canvas.width+0
default_height = cd.canvas.height+0

cd.options.lineWidth=50;
colors = "000000,000033,000066,000099,0000CC,0000FF,003300,003333,003366,003399,0033CC,0033FF,006600,006633,006666,006699,0066CC,0066FF,009900,009933,009966,009999,0099CC,0099FF,00CC00,00CC33,00CC66,00CC99,00CCCC,00CCFF,00FF00,00FF33,00FF66,00FF99,00FFCC,00FFFF,330000,330033,330066,330099,3300CC,3300FF,333300,333333,333366,333399,3333CC,3333FF,336600,336633,336666,336699,3366CC,3366FF,339900,339933,339966,339999,3399CC,3399FF,33CC00,33CC33,33CC66,33CC99,33CCCC,33CCFF,33FF00,33FF33,33FF66,33FF99,33FFCC,33FFFF,660000,660033,660066,660099,6600CC,6600FF,663300,663333,663366,663399,6633CC,6633FF,666600,666633,666666,666699,6666CC,6666FF,669900,669933,669966,669999,6699CC,6699FF,66CC00,66CC33,66CC66,66CC99,66CCCC,66CCFF,66FF00,66FF33,66FF66,66FF99,66FFCC,66FFFF,990000,990033,990066,990099,9900CC,9900FF,993300,993333,993366,993399,9933CC,9933FF,996600,996633,996666,996699,9966CC,9966FF,999900,999933,999966,999999,9999CC,9999FF,99CC00,99CC33,99CC66,99CC99,99CCCC,99CCFF,99FF00,99FF33,99FF66,99FF99,99FFCC,99FFFF,CC0000,CC0033,CC0066,CC0099,CC00CC,CC00FF,CC3300,CC3333,CC3366,CC3399,CC33CC,CC33FF,CC6600,CC6633,CC6666,CC6699,CC66CC,CC66FF,CC9900,CC9933,CC9966,CC9999,CC99CC,CC99FF,CCCC00,CCCC33,CCCC66,CCCC99,CCCCCC,CCCCFF,CCFF00,CCFF33,CCFF66,CCFF99,CCFFCC,CCFFFF,FF0000,FF0033,FF0066,FF0099,FF00CC,FF00FF,FF3300,FF3333,FF3366,FF3399,FF33CC,FF33FF,FF6600,FF6633,FF6666,FF6699,FF66CC,FF66FF,FF9900,FF9933,FF9966,FF9999,FF99CC,FF99FF,FFCC00,FFCC33,FFCC66,FFCC99,FFCCCC,FFCCFF,FFFF00,FFFF33,FFFF66,FFFF99,FFFFCC,FFFFFF".split(",");

cd.setOption("color", '#'+colors[Math.floor(Math.random()*colors.length)]);

socket = io.connect("http://localhost")

socket.on("upload success", (data) ->
  window.location = 'http://www.google.com/searchbyimage?image_url='+encodeURI(data.imgurl)
  )

transDataUri = ->  	
  #window.location=cd.canvas.toDataURL "image/png"
  #alert 'transferstart'
  socket.emit('search', dataurl: cd.canvas.toDataURL("image/png"))
  #alert 'transferend'

#socket.on "news", (data) ->
#  console.log data
#  socket.emit "my other event", my: "data"

$('#search')
  .click(
    -> do transDataUri
  )
  


s = ''
for color in colors
  s = s+'<li style="background-color:#'+color+'" data-color="'+color+'" class="color"></li>'

$('#colors').html(s)

$('.color').click( ->
    cd.setOption("color", @getAttribute("data-color"));
  )

$('#range').change(->
    console.log @.value
    cd.setOption("lineWidth", @value)
  )
  
cd.canvas.ondragover = ->
  @className = "hover"
  false

cd.canvas.ondragend = ->
  @className = ""
  false

cd.canvas.ondrop = (e) ->
  @className = ""
  e.preventDefault()
  file = e.dataTransfer.files[0]
  reader = new FileReader()
  reader.onload = (event) ->
    img = new Image()
    img.onload = (event) ->
      img = @
      if img.width > img.height
        #alert('hi')
        
        newheight = img.height*(default_width / img.width)
        newwidth = default_width
        #window.setTimeout((-> cd.canvas.height = img.height),100)
      else
        #alert('ho')
        newwidth = img.width*(default_height / img.height)
        newheight = default_height
        
        #window.setTimeout((-> cd.canvas.width = img.width),100)
        
        console.log(newwidth+'---'+newheight)
      #alert('now draw 150')
      window.setTimeout((-> 
        cd.canvas.width=newwidth;
        cd.canvas.height=newheight;
        cd.context.drawImage(img, 0,0, newwidth, newheight)
        ),150)
      #alert('draw end')
      
    img.src = event.target.result
    
  
  reader.readAsDataURL file
  false

#some default values
$('#range').val(50)


#flash fun
#pageLoad = ->
#  initCanvas 320, 240

gCtx = null
gCanvas = null
imageData = null
ii = 0
jj = 0
c = 0

initCanvas = (ww, hh) ->
  #alert('hi')
  gCanvas = document.getElementById("canvas")
  w = ww
  h = hh
  gCanvas.style.width = w + "px"
  gCanvas.style.height = h + "px"
  gCanvas.width = w
  gCanvas.height = h
  gCtx = gCanvas.getContext("2d")
  gCtx.clearRect 0, 0, w, h
  imageData = gCtx.getImageData(0, 0, 320, 240)

passLine = (stringPixels) ->
  coll = stringPixels.split("-")
  i = 0
  
  while i < 320
    intVal = parseInt(coll[i])
    r = (intVal >> 16) & 0xff
    g = (intVal >> 8) & 0xff
    b = (intVal) & 0xff
    imageData.data[c + 0] = r
    imageData.data[c + 1] = g
    imageData.data[c + 2] = b
    imageData.data[c + 3] = 128
    c += 4
    i++
  if c >= 320 * 240 * 4
    c = 0
    gCtx.putImageData imageData, 0, 0

captureToCanvas = ->
  flash = document.getElementById("embedflash")
  flash.ccCapture()

$('#capture').click( -> 
  initCanvas(320, 240)
  captureToCanvas()
)

#flash detection script
hasFlash = false
try
  fo = new ActiveXObject("ShockwaveFlash.ShockwaveFlash")
  hasFlash = true  if fo
catch e
  hasFlash = true  unless navigator.mimeTypes["application/x-shockwave-flash"] == undefined
  
if(!hasFlash)
  $('.withflash').hide()

</script>


	    
</body>
</html>
